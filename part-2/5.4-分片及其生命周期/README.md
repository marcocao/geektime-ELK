# 分片及其生命周期
https://www.jianshu.com/p/e409aea74d67
https://www.cnblogs.com/zwt1990/p/7737747.html

在查询初始阶段，查询被广播到索引中每个 shard 的分片副本（主从分片）上。每个分片执行局部的搜索，然后构建一个匹配的优先级队列。

优先级队列

优先级队列仅仅是一个排序的列表，保存着前 n 个匹配的文档。优先级队列的大小取决于分页参数 from 和 size。例如，下面的搜索请求将会获取一个能够容纳 100 个文档的优先队列：

GET /_search
{
  "from": 90,
  "size": 10
}```


查询过程包含下面三个步骤：

客户端发送一个 search 请求到 Node 3，会创建一个空的优先级队列大小为 from + size。
Node 3 将搜索请求转发到索引中的每个分片的一个主（或从）副本上。
每个分片返回 docIDs 并对在其优先队列中的所有排序后的 doc 给协调节点，Node 3，这里会将这些值进行合并放入自己的优先级队列中来得到最后的全局排序结果。
当搜索请求发送到一个节点上时，这个节点变成协调节点，负责将搜索请求广播到所有涉及的分片上，并将这些反馈结果整合成全局的排序结果集返回给客户端。

第一步是将请求广播到每个节点的分片分本上。就像 document GET 请求，搜索请求可以通过主分片或者任何一个从分片处理。这就是更多的从分片（结合更多的硬件）能够提升搜索的吞吐量的原因。协调节点会对搜索请求进行 round-robin 在所有的分片副本中来分散负载压力。

每个分片局部地执行查询，构建 from+size 长度的排序优先级队列——换言之，在该分片上足够多满足全局搜索的结果。这会返回结果的轻量级列表到协调节点上，仅仅包含 doc IDs 和任何用于排序的值，例如 _score。

协调节点合并了这些分片层的结果到自身排序好的优先级队列，就是最后全局排序后的结果集合。查询阶段到此结束。

一个索引可以包含一个或者多个主分片，所以对一个特定索引的搜索请求需要合并来自多个分片的结果。对多个或者所有索引进行的搜索也是按照同样的方式进行的——仅仅包含更多的分片。

作者：朱小虎XiaohuZhu
链接：https://www.jianshu.com/p/e409aea74d67
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
